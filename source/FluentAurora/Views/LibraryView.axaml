<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:fa="using:FluentAvalonia.UI.Controls"
             xmlns:ic="using:FluentIcons.Avalonia.Fluent"
             xmlns:converters="using:FluentAurora.Converters"
             xmlns:vm="using:FluentAurora.ViewModels"
             mc:Ignorable="d"
             x:Class="FluentAurora.Views.LibraryView"
             x:Name="LibraryRoot"
             d:DesignWidth="1000"
             d:DesignHeight="600"
             Padding="16">

    <Design.DataContext>
        <vm:LibraryViewModel />
    </Design.DataContext>

    <UserControl.Resources>
        <converters:PositionToTimeConverter x:Key="TimeConverter" />
        <SolidColorBrush x:Key="HoverBrush" Color="#22FFFFFF" />
        <SolidColorBrush x:Key="SongCardBackground" Color="#1AFFFFFF" />
    </UserControl.Resources>

    <UserControl.Styles>
        <!-- Playlist Header -->
        <Style Selector="TextBlock.playlist-header">
            <Setter Property="FontWeight" Value="SemiBold" />
            <Setter Property="FontSize" Value="16" />
            <Setter Property="VerticalAlignment" Value="Center" />
        </Style>

        <!-- Song Title -->
        <Style Selector="TextBlock.song-title">
            <Setter Property="FontWeight" Value="SemiBold" />
            <Setter Property="FontSize" Value="14" />
            <Setter Property="TextTrimming" Value="CharacterEllipsis" />
        </Style>

        <!-- Song Artist -->
        <Style Selector="TextBlock.song-artist">
            <Setter Property="FontSize" Value="12" />
            <Setter Property="Opacity" Value="0.7" />
            <Setter Property="TextTrimming" Value="CharacterEllipsis" />
        </Style>

        <!-- Song Duration -->
        <Style Selector="TextBlock.song-duration">
            <Setter Property="FontSize" Value="12" />
            <Setter Property="Opacity" Value="0.6" />
            <Setter Property="VerticalAlignment" Value="Center" />
        </Style>

        <!-- Hover effect for songs -->
        <Style Selector="Border.song-item:pointerover">
            <Setter Property="Background" Value="{StaticResource HoverBrush}" />
        </Style>

        <!-- Toggle Button Style -->
        <Style Selector="ToggleButton.view-toggle">
            <Setter Property="MinWidth" Value="140" />
            <Setter Property="Padding" Value="12,6" />
            <Setter Property="CornerRadius" Value="6" />
        </Style>
    </UserControl.Styles>

    <Grid RowDefinitions="Auto,Auto,*" RowSpacing="10">

        <!-- Top Bar -->
        <Grid Grid.Row="0" ColumnDefinitions="Auto,Auto,*"
              IsVisible="{Binding !!Playlists.Count}">
            <Button Grid.Column="0"
                    Command="{Binding AddFolderCommand}"
                    VerticalAlignment="Center"
                    MinWidth="160"
                    Padding="12,6"
                    Margin="0,0,12,0"
                    Background="{DynamicResource AccentButtonBackground}"
                    Foreground="{DynamicResource AccentButtonForeground}"
                    CornerRadius="6"
                    IsEnabled="{Binding !IsIndexing}">
                <StackPanel Orientation="Horizontal" Spacing="8">
                    <ic:SymbolIcon Symbol="FolderAdd" />
                    <TextBlock Text="Add Music Folder" VerticalAlignment="Center" FontWeight="SemiBold" />
                </StackPanel>
            </Button>

            <!-- View Toggle -->
            <ToggleButton Grid.Column="1"
                          IsChecked="{Binding ShowAllSongs}"
                          Classes="view-toggle"
                          VerticalAlignment="Center">
                <StackPanel Orientation="Horizontal" Spacing="8">
                    <ic:SymbolIcon Symbol="{Binding ShowAllSongs, Converter={x:Static converters:BoolToIconConverter.Instance}}" />
                    <TextBlock Text="{Binding ShowAllSongs, Converter={x:Static converters:BoolToViewTextConverter.Instance}}"
                               VerticalAlignment="Center"
                               FontWeight="SemiBold" />
                </StackPanel>
            </ToggleButton>
        </Grid>

        <!-- Indexing Progress -->
        <Border Grid.Row="1"
                IsVisible="{Binding IsIndexing}"
                Background="#1AFFFFFF"
                CornerRadius="8"
                Padding="16,12"
                Margin="0,0,0,8"
                HorizontalAlignment="Center">
            <Grid ColumnDefinitions="Auto,*" ColumnSpacing="12">
                <!-- Loading Icon -->
                <fa:ProgressRing Grid.Column="0"
                                 Foreground="Orange"
                                 Width="24"
                                 Height="24"
                                 IsIndeterminate="True"
                                 VerticalAlignment="Center" />

                <!-- Progress Text -->
                <StackPanel Grid.Column="1" VerticalAlignment="Center" Spacing="4">
                    <TextBlock FontWeight="SemiBold" FontSize="14">
                        <Run Text="Indexing folder: " />
                        <Run Text="{Binding IndexingFolderName}" />
                    </TextBlock>
                    <TextBlock FontSize="12" Opacity="0.8">
                        <Run Text="Added " />
                        <Run Text="{Binding SongsIndexed}" />
                        <Run Text=" of " />
                        <Run Text="{Binding TotalSongsToIndex}" />
                        <Run Text=" songs" />
                    </TextBlock>
                </StackPanel>
            </Grid>
        </Border>

        <!-- Content Area -->
        <Grid Grid.Row="2">
            <!-- Folders View -->
            <ScrollViewer IsVisible="{Binding !ShowAllSongs}"
                          VerticalScrollBarVisibility="Auto"
                          HorizontalScrollBarVisibility="Disabled"
                          Margin="0,8,0,0">
                <ScrollViewer.Transitions>
                    <Transitions>
                        <DoubleTransition Property="Opacity" Duration="0:0:0.3" />
                        <TransformOperationsTransition Property="RenderTransform" Duration="0:0:0.3" Easing="CubicEaseOut" />
                    </Transitions>
                </ScrollViewer.Transitions>
                <ScrollViewer.Styles>
                    <Style Selector="ScrollViewer">
                        <Setter Property="Opacity" Value="0" />
                        <Setter Property="RenderTransform" Value="translateY(20px)" />
                    </Style>
                    <Style Selector="ScrollViewer[IsVisible=true]">
                        <Setter Property="Opacity" Value="1" />
                        <Setter Property="RenderTransform" Value="translateY(0px)" />
                    </Style>
                </ScrollViewer.Styles>
                <Grid>
                    <!-- Empty State -->
                    <Border IsVisible="{Binding !Playlists.Count}"
                            Background="{DynamicResource SystemControlBackgroundBaseLowBrush}"
                            CornerRadius="12"
                            Padding="48"
                            HorizontalAlignment="Center"
                            VerticalAlignment="Center"
                            MaxWidth="400">
                        <StackPanel Spacing="16" HorizontalAlignment="Center">
                            <!-- Icon -->
                            <ic:SymbolIcon Symbol="MusicNote2"
                                           FontSize="64"
                                           Opacity="0.3"
                                           HorizontalAlignment="Center" />

                            <!-- Title -->
                            <TextBlock Text="No Music Folders"
                                       FontSize="20"
                                       FontWeight="SemiBold"
                                       HorizontalAlignment="Center" />

                            <!-- Description -->
                            <TextBlock Text="Get started by adding a folder containing your music files"
                                       FontSize="14"
                                       Opacity="0.7"
                                       TextWrapping="Wrap"
                                       TextAlignment="Center"
                                       HorizontalAlignment="Center" />

                            <!-- Action Button -->
                            <Button Command="{Binding AddFolderCommand}"
                                    HorizontalAlignment="Center"
                                    Padding="16,8"
                                    Background="{DynamicResource AccentButtonBackground}"
                                    Foreground="{DynamicResource AccentButtonForeground}"
                                    CornerRadius="6"
                                    IsEnabled="{Binding !IsIndexing}">
                                <StackPanel Orientation="Horizontal" Spacing="8">
                                    <ic:SymbolIcon Symbol="FolderAdd" FontSize="18" />
                                    <TextBlock Text="Add Music Folder"
                                               VerticalAlignment="Center"
                                               FontWeight="SemiBold" />
                                </StackPanel>
                            </Button>
                        </StackPanel>
                    </Border>
                    <ItemsControl ItemsSource="{Binding Playlists}"
                                  IsVisible="{Binding !!Playlists.Count}">
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <!-- Playlist Card -->
                                <Border CornerRadius="10"
                                        Padding="14"
                                        Margin="0,0,0,16"
                                        BoxShadow="0 2 6 #33000000">
                                    <Expander IsExpanded="{Binding IsExpanded, Mode=TwoWay}">
                                        <!-- Playlist Header -->
                                        <Expander.Header>
                                            <DockPanel LastChildFill="False">
                                                <StackPanel DockPanel.Dock="Left" Orientation="Horizontal" Spacing="10">
                                                    <TextBlock Text="{Binding Name}" Classes="playlist-header">
                                                        <ToolTip.Tip>
                                                            <TextBlock Text="{Binding Path}" />
                                                        </ToolTip.Tip>
                                                    </TextBlock>
                                                    <TextBlock Text="{Binding SongCount, StringFormat='{}{0} songs'}"
                                                               FontSize="12"
                                                               Opacity="0.7"
                                                               VerticalAlignment="Center" />
                                                </StackPanel>

                                                <StackPanel DockPanel.Dock="Right" Orientation="Horizontal" Spacing="8">
                                                    <Button Command="{Binding DataContext.PlayPlaylistCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                                            CommandParameter="{Binding}" ToolTip.Tip="Play All">
                                                        <ic:SymbolIcon Symbol="Play" />
                                                    </Button>
                                                    <Button Command="{Binding DataContext.PlayPlaylistShuffledCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                                            CommandParameter="{Binding}" ToolTip.Tip="Play All (Shuffled)">
                                                        <ic:SymbolIcon Symbol="ArrowShuffle" />
                                                    </Button>
                                                    <Button Command="{Binding DataContext.DeletePlaylistCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                                            CommandParameter="{Binding}" ToolTip.Tip="Delete Playlist">
                                                        <ic:SymbolIcon Symbol="Delete" />
                                                    </Button>
                                                </StackPanel>
                                            </DockPanel>
                                        </Expander.Header>

                                        <!-- Songs List -->
                                        <ItemsControl ItemsSource="{Binding Songs}" Margin="0,8,0,0">
                                            <ItemsControl.ItemsPanel>
                                                <ItemsPanelTemplate>
                                                    <VirtualizingStackPanel />
                                                </ItemsPanelTemplate>
                                            </ItemsControl.ItemsPanel>

                                            <ItemsControl.ItemTemplate>
                                                <DataTemplate>
                                                    <!-- Song Card -->
                                                    <Border Padding="8,6"
                                                            Margin="0,2"
                                                            CornerRadius="6"
                                                            Background="{StaticResource SongCardBackground}"
                                                            Classes="song-item"
                                                            Cursor="Hand"
                                                            Tapped="SongElement_OnTapped">
                                                        <Border.ContextFlyout>
                                                            <MenuFlyout>
                                                                <MenuItem Header="Play"
                                                                          Command="{Binding DataContext.PlaySongCommand, ElementName=LibraryRoot}"
                                                                          CommandParameter="{Binding}">
                                                                    <MenuItem.Icon>
                                                                        <ic:SymbolIcon Symbol="Play" />
                                                                    </MenuItem.Icon>
                                                                </MenuItem>
                                                                <MenuItem Header="Add to Queue"
                                                                          Command="{Binding DataContext.EnqueueSongCommand, ElementName=LibraryRoot}"
                                                                          CommandParameter="{Binding}">
                                                                    <MenuItem.Icon>
                                                                        <ic:SymbolIcon Symbol="Add" />
                                                                    </MenuItem.Icon>
                                                                </MenuItem>
                                                                <MenuItem Header="Remove Song"
                                                                          Command="{Binding DataContext.RemoveSongCommand, ElementName=LibraryRoot}"
                                                                          CommandParameter="{Binding}">
                                                                    <MenuItem.Icon>
                                                                        <ic:SymbolIcon Symbol="Delete" />
                                                                    </MenuItem.Icon>
                                                                </MenuItem>
                                                            </MenuFlyout>
                                                        </Border.ContextFlyout>

                                                        <Grid ColumnDefinitions="Auto,*,Auto" Background="Transparent">
                                                            <!-- Music Icon -->
                                                            <Border Width="32" Height="32"
                                                                    CornerRadius="4"
                                                                    Background="#FF2D2D2D"
                                                                    Margin="0,0,12,0">
                                                                <ic:SymbolIcon Symbol="MusicNote2"
                                                                               FontSize="16"
                                                                               Opacity="0.5"
                                                                               HorizontalAlignment="Center"
                                                                               VerticalAlignment="Center" />
                                                            </Border>

                                                            <!-- Title / Artist -->
                                                            <StackPanel Grid.Column="1"
                                                                        Orientation="Vertical"
                                                                        VerticalAlignment="Center"
                                                                        Margin="0,0,8,0">
                                                                <ToolTip.Tip>
                                                                    <TextBlock Text="{Binding FilePath}" />
                                                                </ToolTip.Tip>
                                                                <TextBlock Text="{Binding Title}" Classes="song-title" />
                                                                <TextBlock Text="{Binding Artist}" Classes="song-artist" />
                                                            </StackPanel>

                                                            <!-- Duration -->
                                                            <TextBlock Grid.Column="2"
                                                                       Text="{Binding Duration, Converter={StaticResource TimeConverter}}"
                                                                       Classes="song-duration" />
                                                        </Grid>
                                                    </Border>
                                                </DataTemplate>
                                            </ItemsControl.ItemTemplate>
                                        </ItemsControl>
                                    </Expander>
                                </Border>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </Grid>
            </ScrollViewer>

            <!-- All Songs View -->
            <Grid IsVisible="{Binding ShowAllSongs}"
                  RowDefinitions="Auto,*">
                <Grid.Transitions>
                    <Transitions>
                        <DoubleTransition Property="Opacity" Duration="0:0:0.3" />
                        <TransformOperationsTransition Property="RenderTransform" Duration="0:0:0.3" Easing="CubicEaseOut" />
                    </Transitions>
                </Grid.Transitions>
                <Grid.Styles>
                    <Style Selector="Grid">
                        <Setter Property="Opacity" Value="0" />
                        <Setter Property="RenderTransform" Value="translateY(20px)" />
                    </Style>
                    <Style Selector="Grid[IsVisible=true]">
                        <Setter Property="Opacity" Value="1" />
                        <Setter Property="RenderTransform" Value="translateY(0px)" />
                    </Style>
                </Grid.Styles>
                <!-- All Songs Header -->
                <Border Grid.Row="0"
                        Background="{DynamicResource SystemControlBackgroundBaseLowBrush}"
                        CornerRadius="10"
                        Padding="14"
                        Margin="0,8,0,12">
                    <Grid RowDefinitions="Auto,Auto" RowSpacing="12">
                        <!-- Title and Actions Row -->
                        <DockPanel Grid.Row="0" LastChildFill="False">
                            <StackPanel DockPanel.Dock="Left" Orientation="Horizontal" Spacing="10">
                                <TextBlock Text="All Songs" Classes="playlist-header" />
                                <TextBlock Text="{Binding DisplayedSongs.Count, StringFormat='{}{0} songs'}"
                                           FontSize="12"
                                           Opacity="0.7"
                                           VerticalAlignment="Center" />
                                <TextBlock Text="{Binding TotalSongCount, StringFormat='(of {0} total)'}"
                                           FontSize="12"
                                           Opacity="0.5"
                                           VerticalAlignment="Center"
                                           IsVisible="{Binding !!SearchQuery.Length}" />
                            </StackPanel>

                            <StackPanel DockPanel.Dock="Right" Orientation="Horizontal" Spacing="8">
                                <Button Command="{Binding PlayAllSongsCommand}"
                                        ToolTip.Tip="Play All"
                                        IsEnabled="{Binding !IsLoadingSongs}">
                                    <ic:SymbolIcon Symbol="Play" />
                                </Button>
                                <Button Command="{Binding PlayAllSongsShuffledCommand}"
                                        ToolTip.Tip="Play All (Shuffled)"
                                        IsEnabled="{Binding !IsLoadingSongs}">
                                    <ic:SymbolIcon Symbol="ArrowShuffle" />
                                </Button>
                            </StackPanel>
                        </DockPanel>

                        <!-- Search Box Row -->
                        <Border Grid.Row="1"
                                Background="{DynamicResource ControlFillColorDefaultBrush}"
                                CornerRadius="6"
                                Padding="10,6">
                            <Grid ColumnDefinitions="Auto,*,Auto">
                                <!-- Search Icon or Loading -->
                                <Panel Grid.Column="0" Margin="0,0,8,0">
                                    <ic:SymbolIcon Symbol="Search"
                                                   FontSize="16"
                                                   Opacity="0.6"
                                                   VerticalAlignment="Center"
                                                   IsVisible="{Binding !IsSearching}" />
                                    <fa:ProgressRing Width="16"
                                                     Height="16"
                                                     IsVisible="{Binding IsSearching}"
                                                     IsIndeterminate="True" />
                                </Panel>

                                <!-- Search Box -->
                                <TextBox Grid.Column="1"
                                         Text="{Binding SearchQuery}"
                                         Watermark="Search by title, artist, or album..."
                                         BorderThickness="0"
                                         Background="Transparent"
                                         VerticalAlignment="Center"
                                         VerticalContentAlignment="Center"
                                         Padding="0">
                                    <TextBox.Styles>
                                        <Style Selector="TextBox:focus /template/ Border#PART_BorderElement">
                                            <Setter Property="Background" Value="Transparent" />
                                            <Setter Property="BorderThickness" Value="0" />
                                        </Style>
                                    </TextBox.Styles>
                                </TextBox>

                                <!-- Clear Button -->
                                <Button Grid.Column="2"
                                        Command="{Binding ClearSearchCommand}"
                                        IsVisible="{Binding !!SearchQuery.Length}"
                                        Width="24"
                                        Height="24"
                                        Padding="0"
                                        Background="Transparent"
                                        ToolTip.Tip="Clear Search">
                                    <ic:SymbolIcon Symbol="Dismiss" FontSize="14" />
                                </Button>
                            </Grid>
                        </Border>
                    </Grid>
                </Border>


                <!-- Loading Indicator -->
                <fa:ProgressRing Grid.Row="1"
                                 IsVisible="{Binding IsLoadingSongs}"
                                 Width="48"
                                 Height="48"
                                 HorizontalAlignment="Center"
                                 VerticalAlignment="Center"
                                 IsIndeterminate="True" />

                <!-- Songs List -->
                <ScrollViewer Grid.Row="1"
                              IsVisible="{Binding !IsLoadingSongs}"
                              VerticalScrollBarVisibility="Auto"
                              HorizontalScrollBarVisibility="Disabled">
                    <ItemsControl ItemsSource="{Binding DisplayedSongs}"
                                  Padding="0,0,8,0">
                        <ItemsControl.ItemsPanel>
                            <ItemsPanelTemplate>
                                <VirtualizingStackPanel />
                            </ItemsPanelTemplate>
                        </ItemsControl.ItemsPanel>

                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <!-- Song Card -->
                                <Border Padding="8,6"
                                        Margin="0,2"
                                        CornerRadius="6"
                                        Background="{StaticResource SongCardBackground}"
                                        Classes="song-item"
                                        Cursor="Hand"
                                        Tapped="SongElement_OnTapped">
                                    <Border.ContextFlyout>
                                        <MenuFlyout>
                                            <MenuItem Header="Play"
                                                      Command="{Binding DataContext.PlaySongCommand, ElementName=LibraryRoot}"
                                                      CommandParameter="{Binding}">
                                                <MenuItem.Icon>
                                                    <ic:SymbolIcon Symbol="Play" />
                                                </MenuItem.Icon>
                                            </MenuItem>
                                            <MenuItem Header="Add to Queue"
                                                      Command="{Binding DataContext.EnqueueSongCommand, ElementName=LibraryRoot}"
                                                      CommandParameter="{Binding}">
                                                <MenuItem.Icon>
                                                    <ic:SymbolIcon Symbol="Add" />
                                                </MenuItem.Icon>
                                            </MenuItem>
                                            <MenuItem Header="Remove Song"
                                                      Command="{Binding DataContext.RemoveSongCommand, ElementName=LibraryRoot}"
                                                      CommandParameter="{Binding}">
                                                <MenuItem.Icon>
                                                    <ic:SymbolIcon Symbol="Delete" />
                                                </MenuItem.Icon>
                                            </MenuItem>
                                        </MenuFlyout>
                                    </Border.ContextFlyout>

                                    <Grid ColumnDefinitions="Auto,*,Auto" Background="Transparent">
                                        <!-- Music Icon -->
                                        <Border Width="32" Height="32"
                                                CornerRadius="4"
                                                Background="#FF2D2D2D"
                                                Margin="0,0,12,0">
                                            <ic:SymbolIcon Symbol="MusicNote2"
                                                           FontSize="16"
                                                           Opacity="0.5"
                                                           HorizontalAlignment="Center"
                                                           VerticalAlignment="Center" />
                                        </Border>

                                        <!-- Title / Artist -->
                                        <StackPanel Grid.Column="1"
                                                    Orientation="Vertical"
                                                    VerticalAlignment="Center"
                                                    Margin="0,0,8,0">
                                            <ToolTip.Tip>
                                                <TextBlock Text="{Binding FilePath}" />
                                            </ToolTip.Tip>
                                            <TextBlock Text="{Binding Title}" Classes="song-title" />
                                            <TextBlock Text="{Binding Artist}" Classes="song-artist" />
                                        </StackPanel>

                                        <!-- Duration -->
                                        <TextBlock Grid.Column="2"
                                                   Text="{Binding Duration, Converter={StaticResource TimeConverter}}"
                                                   Classes="song-duration" />
                                    </Grid>
                                </Border>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </ScrollViewer>
            </Grid>
        </Grid>
    </Grid>
</UserControl>